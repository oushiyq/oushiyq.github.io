<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Core Image实战之一 | Daniel Young&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="写在前面最近在公司做项目要用到Core Image，而之前对于CoreImage和GPUImage都基本没有了解过。于是趁着项目的驱动，做了一个小Demo。
Core Image简介
Core Image is an image processing and analysis technology designed to provide near real-time processing for">
<meta property="og:type" content="article">
<meta property="og:title" content="Core Image实战之一">
<meta property="og:url" content="http://yoursite.com/2016/07/07/GPUImage实战/index.html">
<meta property="og:site_name" content="Daniel Young's blog">
<meta property="og:description" content="写在前面最近在公司做项目要用到Core Image，而之前对于CoreImage和GPUImage都基本没有了解过。于是趁着项目的驱动，做了一个小Demo。
Core Image简介
Core Image is an image processing and analysis technology designed to provide near real-time processing for">
<meta property="og:image" content="http://7xqzfr.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-16%20%E4%B8%8B%E5%8D%885.18.40.png">
<meta property="og:image" content="http://7xqzfr.com1.z0.glb.clouddn.com/coreimage.gif?imageView/2/w/300/q/90">
<meta property="og:updated_time" content="2016-07-16T11:30:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Core Image实战之一">
<meta name="twitter:description" content="写在前面最近在公司做项目要用到Core Image，而之前对于CoreImage和GPUImage都基本没有了解过。于是趁着项目的驱动，做了一个小Demo。
Core Image简介
Core Image is an image processing and analysis technology designed to provide near real-time processing for">
  
    <link rel="alternative" href="/atom.xml" title="Daniel Young&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xqzfr.com1.z0.glb.clouddn.com/221_FfjKG6931FeJ3e2GkzbG_square.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Daniel Young</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>標籤</li>
						
						
						<li>關於</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">逗逼一枚…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Daniel Young</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://7xqzfr.com1.z0.glb.clouddn.com/221_FfjKG6931FeJ3e2GkzbG_square.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Daniel Young</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-GPUImage实战" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/07/GPUImage实战/" class="article-date">
  	<time datetime="2016-07-07T04:21:38.000Z" itemprop="datePublished">2016-07-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Core Image实战之一
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="u5199_u5728_u524D_u9762"><a href="#u5199_u5728_u524D_u9762" class="headerlink" title="写在前面"></a>写在前面</h3><p>最近在公司做项目要用到Core Image，而之前对于CoreImage和GPUImage都基本没有了解过。于是趁着项目的驱动，做了一个小Demo。</p>
<h2 id="Core_Image_u7B80_u4ECB"><a href="#Core_Image_u7B80_u4ECB" class="headerlink" title="Core Image简介"></a>Core Image简介</h2><blockquote>
<p>Core Image is an image processing and analysis technology designed to provide near real-time processing for still and video images. It operates on image data types from the Core Graphics, Core Video, and Image I/O frameworks, using either a GPU or CPU rendering path. Core Image hides the details of low-level graphics processing by providing an easy-to-use application programming interface (API). You don’t need to know the details of OpenGL or OpenGL ES to leverage the power of the GPU, nor do you need to know anything about Grand Central Dispatch (GCD) to get the benefit of multicore processing. Core Image handles the details for you.</p>
</blockquote>
<p>这是苹果官方文档对于Core Image的介绍，大致意思是：Core Image是一种为静态图像和video图像提供处理和分析的技术，它可以使用GPU/CPU的方式对图像进行处理。Core Image提供了简洁的API给用户，隐藏了图像处理中复杂的底层内容。你可以在不了解OpenGL、OpenGL ES甚至是GCD的基础上对其进行使用，他已经帮你对这些复杂的内容进行处理了。废话这么多，苹果就想告诉我们一件事：所有的底层细节他都帮你做好了，你只需要调用API就行了。</p>
<h2 id="u6EE4_u955C_u4E0E_u6EE4_u955C_u94FE"><a href="#u6EE4_u955C_u4E0E_u6EE4_u955C_u94FE" class="headerlink" title="滤镜与滤镜链"></a>滤镜与滤镜链</h2><p>一个滤镜是一个对象，有很多输入和输出，并执行一些变换。例如，模糊滤镜可能需要输入图像和一个模糊半径来产生适当的模糊后的输出图像。<br>一个滤镜图表是一个链接在一起的滤镜网络 (无回路有向图)，使得一个滤镜的输出可以是另一个滤镜的输入。以这种方式，可以实现精心制作的效果。<br>Core Image的实现可以参考下面的图：<br><img src="http://7xqzfr.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-16%20%E4%B8%8B%E5%8D%885.18.40.png" alt=""><br>每个图片对象经过滤镜后作为下一个滤镜的输入（滤镜链），或者直接输出（单个滤镜）。</p>
<h2 id="Core_Image_u2019s_API"><a href="#Core_Image_u2019s_API" class="headerlink" title="Core Image’s API"></a>Core Image’s API</h2><p>Core Image的API主要就是三类：CIImage表示输入的图片；CIFilter表示经过的滤镜；CIContext表示上下文，可以从其中取得图片的信息。</p>
<ul>
<li><p>CIImage<br>保存图像数据的类，可以通过UIImage，图像文件或者像素数据来创建，包括未处理的像素数据。一般我们输入的都是UIImage，可以使用：imageWithCGImage:类方法获取CIImage。</p>
</li>
<li><p>CIFilter<br>滤镜类，这个框架中对图片属性进行细节处理的类。它对所有的像素进行操作，用一些键-值设置来决定具体操作的程度。</p>
</li>
<li><p>CIContext<br>上下文类，如CoreGraphics以及CoreData中的上下文用于处理绘制渲染以及处理托管对象一样，CoreImage的上下文也是实现对图像处理的具体对象。<br>这里需要注意的是在Context创建的时候，我们需要给它设定为是基于GPU还是CPU。<br>基于GPU的话，处理速度更快，因为利用了GPU硬件的并行优势。但是GPU受限于硬件纹理尺寸，而且如果你的程序在后台继续处理和保存图片的话，那么需要使用CPU，因为当app切换到后台状态时GPU处理会被打断。</p>
</li>
</ul>
<h3 id="u4F7F_u7528_u6B65_u594F"><a href="#u4F7F_u7528_u6B65_u594F" class="headerlink" title="使用步奏"></a>使用步奏</h3><ol>
<li><p>创建图像上下文 CIContext</p>
</li>
<li><p>创建滤镜 CIFilter</p>
</li>
<li><p>创建过滤原图片 CIImage</p>
</li>
<li><p>调用 CIFilter 的 setValue:forKey:方法为滤镜指定源图片</p>
</li>
<li><p>设置滤镜参数【可选】</p>
</li>
<li><p>取得输出图片显示或保存</p>
</li>
</ol>
<p>具体实现可以参考最下面的Demo。</p>
<h2 id="GPUImage_u7B80_u4ECB"><a href="#GPUImage_u7B80_u4ECB" class="headerlink" title="GPUImage简介"></a>GPUImage简介</h2><blockquote>
<p>The GPUImage framework is a BSD-licensed iOS library that lets you apply GPU-accelerated filters and other effects to images, live camera video, and movies. In comparison to Core Image (part of iOS 5.0), GPUImage allows you to write your own custom filters, supports deployment to iOS 4.0, and has a simpler interface. However, it currently lacks some of the more advanced features of Core Image, such as facial detection.</p>
</blockquote>
<p>这是Brad Larson的Github对GPUImage做出的介绍，大致就是GPUImage以BSD协议放出，能够在图像、实时摄像头影像和视频上使用GPU加速的滤镜和其他效果。但是他相比于Core Image还是有不足的地方，就是他不支持面部检测。<br>GPUImage的使用和Core Image非常类似，也是将前一个滤镜的输出作为下一个滤镜的输入来实现滤镜链。</p>
<h2 id="GPUImage_u7684_u4F7F_u7528"><a href="#GPUImage_u7684_u4F7F_u7528" class="headerlink" title="GPUImage的使用"></a>GPUImage的使用</h2><p>Brad Larson在GPUImage的github上给出了使用方法，这里贴出来：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIImage</span> *inputImage = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"Lambeau.jpg"</span>];</span><br><span class="line"></span><br><span class="line">GP<span class="built_in">UImagePicture</span> *stillImageSource = [[GP<span class="built_in">UImagePicture</span> alloc] initWithImage:inputImage];</span><br><span class="line">GP<span class="built_in">UImageSepiaFilter</span> *stillImageFilter = [[GP<span class="built_in">UImageSepiaFilter</span> alloc] init];</span><br><span class="line"></span><br><span class="line">[stillImageSource addTarget:stillImageFilter];</span><br><span class="line">[stillImageFilter useNextFrameForImageCapture];</span><br><span class="line">[stillImageSource processImage];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIImage</span> *currentFilteredVideoFrame = [stillImageFilter imageFromCurrentFramebuffer];</span><br></pre></td></tr></table></figure></p>
<p>如果只经过一个滤镜直接输出的话，可以简化为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GP<span class="built_in">UImageSepiaFilter</span> *stillImageFilter2 = [[GP<span class="built_in">UImageSepiaFilter</span> alloc] init];</span><br><span class="line"><span class="built_in">UIImage</span> *quickFilteredImage = [stillImageFilter2 imageByFilteringImage:inputImage];</span><br></pre></td></tr></table></figure>
<h2 id="u4E00_u4E2A_u7B80_u5355_u7684_u6EE4_u955CAPP"><a href="#u4E00_u4E2A_u7B80_u5355_u7684_u6EE4_u955CAPP" class="headerlink" title="一个简单的滤镜APP"></a>一个简单的滤镜APP</h2><p>前段时间用GPUImage做过一次，最近又用Core Image重构了一遍，两者的使用实际上差不了太多，下面是实际效果和代码。</p>
<p><img src="http://7xqzfr.com1.z0.glb.clouddn.com/coreimage.gif?imageView/2/w/300/q/90" alt=""></p>
<p>代码Demo<a href="https://github.com/oushiyq/YQCoreImageDemo" target="_blank" rel="external">在这</a> </p>
<p>参考资料</p>
<p>1.<a href="https://objccn.io/issue-21-6/" target="_blank" rel="external">Core Image 介绍</a> ObjC中国<br>2.<a href="https://developer.apple.com/library/mac/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_intro/ci_intro.html" target="_blank" rel="external">About Core Image</a> Apple<br>3.<a href="https://github.com/BradLarson/GPUImage" target="_blank" rel="external">GPUImage</a> BradLarson </p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/11/09/Core-Image实战之二/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Core Image实战之二
        
      </div>
    </a>
  
  
    <a href="/2016/05/26/APP是如何启动的-理解UIApplication/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">理解UIApplication</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="GPUImage实战" data-title="Core Image实战之一" data-url="http://yoursite.com/2016/07/07/GPUImage实战/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 Daniel Young
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>