<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>深入浅出block | Daniel Young&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="写在前面之前在看《iOS编程》的时候，并没有感觉block有多难，就感觉是一个语法和指针函数差不多的一种匿名函数。但是之后在看了《Objective-C高级编程》和《Effective Objective-C 2.0》之后，发现学长和我说的『block、ARC、GCD、runtime、runloop都属于高级编程的范畴』，果然是没错的。今天在编写『知乎日报』时，也在block中遇到一点困难，于是总">
<meta property="og:type" content="article">
<meta property="og:title" content="深入浅出block">
<meta property="og:url" content="http://yoursite.com/2016/05/10/深入浅出block/index.html">
<meta property="og:site_name" content="Daniel Young's blog">
<meta property="og:description" content="写在前面之前在看《iOS编程》的时候，并没有感觉block有多难，就感觉是一个语法和指针函数差不多的一种匿名函数。但是之后在看了《Objective-C高级编程》和《Effective Objective-C 2.0》之后，发现学长和我说的『block、ARC、GCD、runtime、runloop都属于高级编程的范畴』，果然是没错的。今天在编写『知乎日报』时，也在block中遇到一点困难，于是总">
<meta property="og:updated_time" content="2016-11-30T11:36:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入浅出block">
<meta name="twitter:description" content="写在前面之前在看《iOS编程》的时候，并没有感觉block有多难，就感觉是一个语法和指针函数差不多的一种匿名函数。但是之后在看了《Objective-C高级编程》和《Effective Objective-C 2.0》之后，发现学长和我说的『block、ARC、GCD、runtime、runloop都属于高级编程的范畴』，果然是没错的。今天在编写『知乎日报』时，也在block中遇到一点困难，于是总">
  
    <link rel="alternative" href="/atom.xml" title="Daniel Young&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xqzfr.com1.z0.glb.clouddn.com/221_FfjKG6931FeJ3e2GkzbG_square.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Daniel Young</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>標籤</li>
						
						
						<li>關於</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">逗逼一枚…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Daniel Young</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://7xqzfr.com1.z0.glb.clouddn.com/221_FfjKG6931FeJ3e2GkzbG_square.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Daniel Young</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-深入浅出block" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/10/深入浅出block/" class="article-date">
  	<time datetime="2016-05-10T08:01:22.000Z" itemprop="datePublished">2016-05-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      深入浅出block
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="u5199_u5728_u524D_u9762"><a href="#u5199_u5728_u524D_u9762" class="headerlink" title="写在前面"></a>写在前面</h3><p>之前在看《iOS编程》的时候，并没有感觉block有多难，就感觉是一个语法和指针函数差不多的一种匿名函数。但是之后在看了《Objective-C高级编程》和《Effective Objective-C 2.0》之后，发现学长和我说的『block、ARC、GCD、runtime、runloop都属于高级编程的范畴』，果然是没错的。今天在编写『知乎日报』时，也在block中遇到一点困难，于是总结一下block的用法吧！</p>
<h1 id="u7B80_u5355_u7406_u89E3Block"><a href="#u7B80_u5355_u7406_u89E3Block" class="headerlink" title="简单理解Block"></a>简单理解Block</h1><h2 id="Block_u7B80_u4ECB"><a href="#Block_u7B80_u4ECB" class="headerlink" title="Block简介"></a>Block简介</h2><p>block作为C语言的扩展，并不是高新技术，和其他语言的闭包或lambda表达式是一回事。Block的使用很像函数指针，不过与函数最大的不同是：Block可以访问函数以外、词法作用域以内的外部变量的值。换句话说，Block不仅<strong>实现函数的功能</strong>，还能<strong>携带函数的执行环境</strong>。</p>
<p>可以这样理解，Block其实包含两个部分内容</p>
<ol>
<li>Block执行的代码，这是在编译的时候已经生成好的；</li>
<li>一个包含Block执行时需要的所有外部变量值的数据结构。Block将使用到的、作用域附近到的变量的值建立一份快照拷贝到栈上。</li>
</ol>
<h2 id="Block_u57FA_u672C_u8BED_u6CD5"><a href="#Block_u57FA_u672C_u8BED_u6CD5" class="headerlink" title="Block基本语法"></a>Block基本语法</h2><p>先给出一个最简单的定义：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^<span class="keyword">void</span> (<span class="keyword">void</span>)&#123;</span><br><span class="line">	printf(<span class="string">"这是一个block\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如上所示，一个block在语法上可以由4部分组成:<strong> ^ 返回值类型 参数列表 表达式 </strong><br>当返回值类型为void，或者根据表达式可以知道其返回值类型时，返回值类型可以省略。那么block就由3部分组成：<strong> ^ 参数列表 表达式 </strong><br>具体例子如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^ (<span class="keyword">void</span>)&#123;</span><br><span class="line">	printf(<span class="string">"这是一个block\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">^ (<span class="keyword">int</span> a, <span class="keyword">int</span> b)&#123;</span><br><span class="line">	<span class="keyword">return</span> a + b ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//该block语法按照return语句的类型，返回int返回值</span></span><br></pre></td></tr></table></figure>
<p>当然，如果你的block语句中没有参数，那么参数列表也能省略，block语句变成：<strong> ^ 表达式 </strong>。如下所示：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^&#123;</span><br><span class="line">	printf(<span class="string">"这是一个block\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Block_u7C7B_u578B_u53D8_u91CF"><a href="#Block_u7C7B_u578B_u53D8_u91CF" class="headerlink" title="Block类型变量"></a>Block类型变量</h2><p>在block语法中，可将block语法赋值给声明为block类型的变量。声明block类型变量的示例如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> (^blk)(<span class="keyword">int</span>);</span><br></pre></td></tr></table></figure></p>
<p>既然说block是变量，那么他肯定是可以初始化以及赋值的咯，如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//block变量初始化</span></span><br><span class="line"><span class="keyword">int</span> (^blk)(<span class="keyword">int</span>) = ^ (<span class="keyword">int</span> count)&#123;<span class="keyword">return</span> count++;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//block变量赋值</span></span><br><span class="line"><span class="keyword">int</span> (^blk1)(<span class="keyword">int</span>) = blk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> (^blk2)(<span class="keyword">int</span>);</span><br><span class="line">blk2 = blk1;</span><br></pre></td></tr></table></figure></p>
<p>这举的都是比较简单的例子，当block语法的结构变复杂时，这种语法会变得非常难记、难读。因此，我们可以为block起名来表示block的用途，并把其类型隐藏。这就用到了c语言中常见的typedef，比如将上面的代码可以进行以下的改写：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> (^blk)(<span class="keyword">int</span>);</span><br><span class="line"><span class="comment">//定义一个名为blk的类型</span></span><br><span class="line"></span><br><span class="line">blk blk1 = ^ (<span class="keyword">int</span> count)&#123;<span class="keyword">return</span> count++;&#125;;</span><br><span class="line">blk blk2 = blk1;</span><br></pre></td></tr></table></figure></p>
<p>这样，就很轻松的定义了一个返回值和参数都为int类型的block变量了。</p>
<h2 id="u7406_u89E3__block"><a href="#u7406_u89E3__block" class="headerlink" title="理解__block"></a>理解__block</h2><p>block可以理解为『带有自动变量的匿名函数』，其中『带有自动变量』在block中的表现为『截获自动变量』。如下所示：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">void</span> (^logging)(<span class="keyword">void</span>);</span><br><span class="line">        logging blk =  ^ &#123;</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@"a的值是：%d\n"</span>,a);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">        blk();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//print : a的值是：1</span></span><br></pre></td></tr></table></figure></p>
<p>在该源代码中，block语法表达式使用的是之前声明的a的值。因为在block表达式中会保存自动变量的值，并不会随自动变量值的改写而改变。这就是自动变量的截获。<br>若想改变在block语法的表达式中的自动变量，那么只需要在自动变量前面加入__block修饰符就行了。如下所示：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在block外修改自动变量</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        __block <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">void</span> (^logging)(<span class="keyword">void</span>);</span><br><span class="line">        logging blk =  ^ &#123;</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@"a的值是：%d\n"</span>,a);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">        blk();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//print : a的值是：2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//在block内修改自动变量</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        __block <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">void</span> (^logging)(<span class="keyword">void</span>);</span><br><span class="line">        logging blk =  ^ &#123;</span><br><span class="line">                    a = <span class="number">2</span>;</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@"a的值是：%d\n"</span>,a);</span><br><span class="line">        &#125;;</span><br><span class="line">        blk();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//print : a的值是：2</span></span><br></pre></td></tr></table></figure></p>
<p>当block截获被__block修饰的自动变量时，block中自动变量的值是可以改变的。</p>
<h2 id="Block_u4E0E_u5BF9_u8C61_u7684_u5173_u7CFB"><a href="#Block_u4E0E_u5BF9_u8C61_u7684_u5173_u7CFB" class="headerlink" title="Block与对象的关系"></a>Block与对象的关系</h2><p>在苹果公司的官方文档中关于block有这么一句话：</p>
<blockquote>
<p>Blocks are Objective-C objects, which means they can be added to collections like NSArray or NSDictionary.<br>在这里苹果明确是指出了block是一个对象，那么作为一个对象，他和其他对象是否有区别呢？这个可以从block的底层定义出发。在《Objective-C高级编程》中，作者使用clang编译得到了block的结构，如下所示：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __block_impl 是 block 实现的结构体</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *isa;</span><br><span class="line">    <span class="keyword">int</span> Flags;</span><br><span class="line">    <span class="keyword">int</span> Reserved;</span><br><span class="line">    <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>可以看到block实现的结构体中包含了一个isa的指针，而我们很清楚isa在oc中表示的是对象的类型。在block中默认的block类型为_NSConcreteStackBlock。如同名字一样，block对象默认为在栈上分配，而普通对象一般分配在堆中。这就是block对象和对象之间的区别。</p>
<h2 id="block_u7684_u7C7B_u578B_u4E0E_u4F7F_u7528"><a href="#block_u7684_u7C7B_u578B_u4E0E_u4F7F_u7528" class="headerlink" title="block的类型与使用"></a>block的类型与使用</h2><p>在上一节中说到block对象类型默认为_NSConcreteStackBlock，那么是否还有其他类型？答案是肯定的，block一共有三种类型：_NSConcreteGlobalBlock、_NSConcreteStackBlock和_NSConcreteMallocBlock。其区别如下：</p>
<table>
<thead>
<tr>
<th>类</th>
<th style="text-align:center">block对象的存储域</th>
</tr>
</thead>
<tbody>
<tr>
<td>_NSConcreteStackBlock</td>
<td style="text-align:center">栈</td>
</tr>
<tr>
<td>_NSConcreteGlobalBlock</td>
<td style="text-align:center">.data区</td>
</tr>
<tr>
<td>_NSConcreteMallocBlock</td>
<td style="text-align:center">堆</td>
</tr>
</tbody>
</table>
<p>我们可以自己在定义全局变量的地方定义一个_NSConcreteGlobalBlock类型的block对象。另外，我们实现一个不使用应截获的自动变量的block时，也会显示为是它。如果有对自动变量的引用，那么就会显示_NSConcreteStackBlock，他会随着变量作用域的结束而废弃。_NSConcreteMallocBlock就如同malloc表示的一样，在对_NSConcreteStackBlock类型的block进行Block_copy()或者发送了copy时就会得到。<br>因此，在我们对block的使用中，我们应该注意_NSConcreteStackBlock类型的block如果在变量作用域结束后还要存在，那么我们需要对其copy操作。</p>
<h1 id="u4ECEclang_u770BBlock"><a href="#u4ECEclang_u770BBlock" class="headerlink" title="从clang看Block"></a>从clang看Block</h1><p>在开始具体讲clang后的代码之前，先普及几个结构体和函数：</p>
<ol>
<li>struct __block_impl，block结构体，通用的；</li>
<li>struct <strong>main_block_impl_0，block结构体，具体的。main是根据函数名来确定的，最后的0代表第几个block。举个例子，我有个函数叫test，里面定义了两个block，那么那两个block分别叫做</strong>test_block_impl_0和__test_block_impl_1；</li>
<li>static void <strong>main_block_func_0,block的功能。main和0与</strong>main_block_impl_0同理；</li>
<li>struct <strong>main_block_desc_0，block大小和版本号的描述结构体。main和0与</strong>main_block_impl_0同理。</li>
</ol>
<p>上面4个是在未捕捉变量/捕捉的变量前面没有<strong>block时的几个主要结构体和函数，在有</strong>block的情况下还会有</p>
<ol>
<li>struct <strong>Block_byref_val_0, </strong>block生成的结构体，代表着被__block修饰的变量；</li>
<li><strong>main_block_copy_0，复制辅助函数，当block从栈复制到堆中时，</strong>block对象也会被复制到堆中；</li>
<li><strong>main_block_dispose_0，当堆中的block销毁时，</strong>block对象也被销毁。</li>
</ol>
<p>这就是在后面大概需要用到的结构体和函数，具体的功能在下面介绍。</p>
<h2 id="u672A_u6355_u6349_u53D8_u91CF_u7684Block"><a href="#u672A_u6355_u6349_u53D8_u91CF_u7684Block" class="headerlink" title="未捕捉变量的Block"></a>未捕捉变量的Block</h2><p>先给一个最简单的block，没有捕捉任何变量，甚至block里面都没有语句，只是一个block的定义。</p>
<h3 id="clang_rewrite_u524D"><a href="#clang_rewrite_u524D" class="headerlink" title="clang rewrite前"></a>clang rewrite前</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    ^&#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="clang_rewrite_u540E"><a href="#clang_rewrite_u540E" class="headerlink" title="clang rewrite后"></a>clang rewrite后</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl<span class="variable">.Flags</span> = flags;</span><br><span class="line">    impl<span class="variable">.FuncPtr</span> = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在clang rewrite之后，去除一些冗余的函数之后，一共生成了3个结构体，2个函数。按照c程序的执行顺序来看：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个main函数看上去转换太多，有点复杂。事实上，在把转换去掉之后，我们可以得到：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    __main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样，『^{};』这样的一个block在重写之后变成了一个函数：<strong>main_block_impl_0。即，block的实现就是</strong>main_block_impl_0。<br>然后，根据<strong>main_block_impl_0的定义和他的参数（(void *)</strong>main_block_func_0, &amp;__main_block_desc_0_DATA)：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl<span class="variable">.Flags</span> = flags;</span><br><span class="line">    impl<span class="variable">.FuncPtr</span> = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>第一个成员struct __block_impl impl的定义如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>从isa，我们可以知道block事实上是对象，FuncPtr指针指向block的实现。将参数带入__main_block_impl_0，我们可以根据构造函数进行初始化：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">   impl<span class="variable">.Flags</span> = <span class="number">0</span>;</span><br><span class="line">   impl<span class="variable">.Reserved</span> = <span class="number">0</span>;</span><br><span class="line">   impl<span class="variable">.FuncPtr</span> = __main_block_func_0;</span><br><span class="line">   Desc = &amp;__main_block_desc_0_DATA;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样block就rewrite成了<strong>main_block_impl_0结构体。impl.FuncPtr = </strong>main_block_func_0，代表block的实现。因为我们的block中没有任何语句。所以__main_block_func_0函数为：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Desc = &amp;__main_block_desc_0_DATA,即block的大小<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br></pre></td></tr></table></figure></p>
<p>__main_block_desc_0还描述了block的版本号reserved，目前版本号都是0。</p>
<h2 id="u6355_u6349_u53D8_u91CF_u7684Block"><a href="#u6355_u6349_u53D8_u91CF_u7684Block" class="headerlink" title="捕捉变量的Block"></a>捕捉变量的Block</h2><p>在block中用到的变量有全局变量、静态全局变量、静态变量和局部变量。在下面的代码中，我定义了上述的所有变量：</p>
<h3 id="clang_rewrite_u524D-1"><a href="#clang_rewrite_u524D-1" class="headerlink" title="clang rewrite前"></a>clang rewrite前</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> global_val = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> static_global_val = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_val = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">void</span>(^blk)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">        global_val ++;</span><br><span class="line">        static_global_val ++;</span><br><span class="line">        static_val ++;</span><br><span class="line">        val;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="clang_rewrite_u540E-1"><a href="#clang_rewrite_u540E-1" class="headerlink" title="clang rewrite后"></a>clang rewrite后</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> global_val = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> static_global_val = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="keyword">int</span> *static_val;</span><br><span class="line">  <span class="keyword">int</span> val;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> *_static_val, <span class="keyword">int</span> _val, <span class="keyword">int</span> flags=<span class="number">0</span>) : static_val(_static_val), val(_val) &#123;</span><br><span class="line">    impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl<span class="variable">.Flags</span> = flags;</span><br><span class="line">    impl<span class="variable">.FuncPtr</span> = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">int</span> *static_val = __cself-&gt;static_val; <span class="comment">// bound by copy</span></span><br><span class="line">  <span class="keyword">int</span> val = __cself-&gt;val; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">        global_val ++;</span><br><span class="line">        static_global_val ++;</span><br><span class="line">        (*static_val) ++;</span><br><span class="line">        val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_val = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">void</span>(*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;static_val, val));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在rewrite之后，可以看到生成了同之前所述的那些结构体和函数，但是其中还是有一些不同：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> global_val = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> static_global_val = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="keyword">int</span> *static_val;</span><br><span class="line">  <span class="keyword">int</span> val;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> *_static_val, <span class="keyword">int</span> _val, <span class="keyword">int</span> flags=<span class="number">0</span>) : static_val(_static_val), val(_val) &#123;</span><br><span class="line">    impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl<span class="variable">.Flags</span> = flags;</span><br><span class="line">    impl<span class="variable">.FuncPtr</span> = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看到<strong>main_block_impl_0中多了两个成员变量*static_val和val，初始化</strong>main_block_impl_0可以得到：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">   impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">   impl<span class="variable">.Flags</span> = <span class="number">0</span>;</span><br><span class="line">   impl<span class="variable">.Reserved</span> = <span class="number">0</span>;</span><br><span class="line">   impl<span class="variable">.FuncPtr</span> = __main_block_func_0;</span><br><span class="line">   Desc = &amp;__main_block_desc_0_DATA;</span><br><span class="line">   *static_val = <span class="number">3</span>;</span><br><span class="line">   val = <span class="number">4</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>而static_val变成了一个指针，val却还是局部变量。这也就是static_val可以直接在block进行修改，val不能进行修改的原因。val要在block中进行修改的话，那么需要在前面加上__block修饰。</p>
<h2 id="u6355_u6349_u5E26_u6709__block_u4FEE_u9970_u7684_u53D8_u91CF_u7684Block"><a href="#u6355_u6349_u5E26_u6709__block_u4FEE_u9970_u7684_u53D8_u91CF_u7684Block" class="headerlink" title="捕捉带有__block修饰的变量的Block"></a>捕捉带有__block修饰的变量的Block</h2><p>当我们需要对捕捉的变量在block中修改时，需要在前面加上__block进行修饰。当然还有一种办法是通过指针，不过这种方法很容易出现野指针。</p>
<h3 id="clang_rewrite_u524D-2"><a href="#clang_rewrite_u524D-2" class="headerlink" title="clang rewrite前"></a>clang rewrite前</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> global_val = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> static_global_val = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_val = <span class="number">3</span>;</span><br><span class="line">    __block <span class="keyword">int</span> val = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">void</span>(^blk)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">        global_val ++;</span><br><span class="line">        static_global_val ++;</span><br><span class="line">        static_val ++;</span><br><span class="line">        val = <span class="number">5</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="clang_rewrite_u540E-2"><a href="#clang_rewrite_u540E-2" class="headerlink" title="clang rewrite后"></a>clang rewrite后</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __Block_byref_val_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_val_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">int</span> val;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="keyword">int</span> *static_val;</span><br><span class="line">  __Block_byref_val_0 *val; <span class="comment">// by ref</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> *_static_val, __Block_byref_val_0 *_val, <span class="keyword">int</span> flags=<span class="number">0</span>) : static_val(_static_val), val(_val-&gt;__forwarding) &#123;</span><br><span class="line">    impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl<span class="variable">.Flags</span> = flags;</span><br><span class="line">    impl<span class="variable">.FuncPtr</span> = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="comment">// bound by ref</span></span><br><span class="line">  <span class="keyword">int</span> *static_val = __cself-&gt;static_val; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">        global_val ++;</span><br><span class="line">        static_global_val ++;</span><br><span class="line">        (*static_val) ++;</span><br><span class="line">        (val-&gt;__forwarding-&gt;val) = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;val, (<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_val = <span class="number">3</span>;</span><br><span class="line">    __attribute__((__blocks__(<span class="keyword">byref</span>))) __Block_byref_val_0 val = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_val_0 *)&amp;val, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_val_0), <span class="number">4</span>&#125;;</span><br><span class="line">    <span class="keyword">void</span>(*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;static_val, (__Block_byref_val_0 *)&amp;val, <span class="number">570425344</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和上面的两种情况相比，加了<strong>block之后多生成了1个结构体和2个函数，</strong>main_block_copy_0和<strong>main_block_dispose_0是用于</strong>block对象的复制和销毁的。下面具体说说__Block_byref_val_0：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __Block_byref_val_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_val_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">int</span> val;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>val在被<strong>block修饰以后，变成了一个</strong>Block_byref_val_0的结构体，val被包装在这结构体中。在这里面有一个<strong>forwarding的指针，在下面会有介绍。</strong>main_block_impl_0被初始化为：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">   impl<span class="variable">.Flags</span> = <span class="number">0</span>;</span><br><span class="line">   impl<span class="variable">.Reserved</span> = <span class="number">0</span>;</span><br><span class="line">   impl<span class="variable">.FuncPtr</span> = __main_block_func_0;</span><br><span class="line">   Desc = &amp;__main_block_desc_0_DATA;</span><br><span class="line">   *static_val = <span class="number">3</span>;</span><br><span class="line">   val<span class="variable">.isa</span> = <span class="number">0</span>;</span><br><span class="line">   val<span class="variable">.forwarding</span> = &amp;val;</span><br><span class="line">   val<span class="variable">.flags</span> = <span class="number">0</span>;</span><br><span class="line">   val<span class="variable">.size</span> = <span class="keyword">sizeof</span>(__Block_byref_val_0);</span><br><span class="line">   val<span class="variable">.val</span> = <span class="number">4</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="forwarding_u7684_u4F5C_u7528"><a href="#forwarding_u7684_u4F5C_u7528" class="headerlink" title="forwarding的作用"></a>forwarding的作用</h2><p>在<strong>Block_byref_val_0结构体中存在一个</strong>forwarding的指针，代码如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="comment">// bound by ref</span></span><br><span class="line">  <span class="keyword">int</span> *static_val = __cself-&gt;static_val; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">        global_val ++;</span><br><span class="line">        static_global_val ++;</span><br><span class="line">        (*static_val) ++;</span><br><span class="line">        (val-&gt;__forwarding-&gt;val) = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在block中改变了<strong>block int val的值，rewrite后成了 (val-&gt;</strong>forwarding-&gt;val) = 5，在这里使用<strong>forwarding的原因是：</strong>forwarding可以实现无论<strong>block变量是在栈还是堆中，都能正确的得到val的值。<br>可能这里的解释有点抽象，那么下面举个例子：<br>假如有一个栈block被copy到堆上，</strong>forwarding指向如下图所示，当<strong>block变量的值改变时，栈block和堆block中的val同时变化。<br>![</strong>block_byref的forwarding](<a href="http://7xqzfr.com1.z0.glb.clouddn.com/block.png" target="_blank" rel="external">http://7xqzfr.com1.z0.glb.clouddn.com/block.png</a>)<br>如果没有<strong>forwarding指针，val-&gt;val,copy-&gt;val，这样两者的</strong>block变量无法同时改变，可能val-&gt;val变为其他值了，copy-&gt;val还是原来的值。</p>
<p>参考资料：</p>
<ol>
<li>《Objective-C高级编程 iOS与OS X多线程和内存管理》Kazuki Sakamoto，Tomohiko Furumoto </li>
<li>《Effective Objective-C 2.0》 Matt Galloway</li>
<li>《iOS开发进阶》 唐巧</li>
<li>《iOS编程》Christian Keur，Aaron Hillegass，Joe Conway </li>
<li><a href="http://tanqisen.github.io/blog/2013/04/19/gcd-block-cycle-retain/" target="_blank" rel="external">正确使用Block避免Cycle Retain和Crash</a></li>
<li><a href="http://www.molotang.com/articles/1691.html" target="_blank" rel="external">深入理解Objective-C的Block</a></li>
</ol>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/17/知乎日报-仿/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          知乎日报(仿)
        
      </div>
    </a>
  
  
    <a href="/2016/05/03/最近需要用到的一些第三方库/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">最近需要用到的一些第三方库</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="深入浅出block" data-title="深入浅出block" data-url="http://yoursite.com/2016/05/10/深入浅出block/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Daniel Young
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>